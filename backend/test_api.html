<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test API SQLite - Interface CAH</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
        .result { margin-top: 10px; }
    </style>
</head>
<body>
    <h1>üß™ Test API SQLite - Interface CAH</h1>
    
    <div class="test-section">
        <h3>1. Test de sant√© du serveur</h3>
        <button onclick="testHealth()">Tester la sant√©</button>
        <div id="health-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h3>2. Test des immeubles</h3>
        <button onclick="testBuildings()">R√©cup√©rer les immeubles</button>
        <button onclick="createTestBuilding()">Cr√©er un immeuble de test</button>
        <div id="buildings-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h3>3. Test des factures</h3>
        <button onclick="testInvoices()">R√©cup√©rer les factures</button>
        <button onclick="testInvoiceConstants()">R√©cup√©rer les constantes</button>
        <button onclick="createTestInvoice()">Cr√©er une facture de test</button>
        <div id="invoices-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h3>4. Test complet</h3>
        <button onclick="runAllTests()">Lancer tous les tests</button>
        <div id="all-tests-result" class="result"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        
        function displayResult(elementId, data, isError = false) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
            element.parentElement.className = `test-section ${isError ? 'error' : 'success'}`;
        }
        
        async function testHealth() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                displayResult('health-result', data);
            } catch (error) {
                displayResult('health-result', { error: error.message }, true);
            }
        }
        
        async function testBuildings() {
            try {
                const response = await fetch(`${API_BASE}/api/buildings`);
                const data = await response.json();
                displayResult('buildings-result', { count: data.length, buildings: data });
            } catch (error) {
                displayResult('buildings-result', { error: error.message }, true);
            }
        }
        
        async function createTestBuilding() {
            try {
                const testBuilding = {
                    name: "Immeuble Test HTML",
                    address: {
                        street: "456 Test Avenue",
                        city: "Montr√©al",
                        province: "QC",
                        postalCode: "H2B 2B2",
                        country: "Canada"
                    },
                    type: "R√©sidentiel",
                    units: 4,
                    floors: 2,
                    yearBuilt: 2024,
                    notes: "Test via navigateur"
                };
                
                const response = await fetch(`${API_BASE}/api/buildings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testBuilding)
                });
                
                const data = await response.json();
                displayResult('buildings-result', { created: data });
            } catch (error) {
                displayResult('buildings-result', { error: error.message }, true);
            }
        }
        
        async function testInvoices() {
            try {
                const response = await fetch(`${API_BASE}/api/invoices`);
                const data = await response.json();
                displayResult('invoices-result', { count: data.data.length, invoices: data.data });
            } catch (error) {
                displayResult('invoices-result', { error: error.message }, true);
            }
        }
        
        async function testInvoiceConstants() {
            try {
                const response = await fetch(`${API_BASE}/api/invoices/constants`);
                const data = await response.json();
                displayResult('invoices-result', { constants: data });
            } catch (error) {
                displayResult('invoices-result', { error: error.message }, true);
            }
        }
        
        async function createTestInvoice() {
            try {
                const testInvoice = {
                    invoiceNumber: `HTML-TEST-${Date.now()}`,
                    category: "municipal_taxes",
                    source: "Ville de Test",
                    date: new Date().toISOString().split('T')[0],
                    amount: 750.25,
                    currency: "CAD",
                    paymentType: "bank_transfer",
                    notes: "Test facture via navigateur"
                };
                
                const response = await fetch(`${API_BASE}/api/invoices`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testInvoice)
                });
                
                const data = await response.json();
                displayResult('invoices-result', { created: data });
            } catch (error) {
                displayResult('invoices-result', { error: error.message }, true);
            }
        }
        
        async function runAllTests() {
            const results = {};
            
            try {
                // Test sant√©
                const healthResponse = await fetch(`${API_BASE}/health`);
                results.health = { status: healthResponse.status, ok: healthResponse.ok };
                
                // Test immeubles
                const buildingsResponse = await fetch(`${API_BASE}/api/buildings`);
                const buildingsData = await buildingsResponse.json();
                results.buildings = { status: buildingsResponse.status, count: buildingsData.length };
                
                // Test factures
                const invoicesResponse = await fetch(`${API_BASE}/api/invoices`);
                const invoicesData = await invoicesResponse.json();
                results.invoices = { status: invoicesResponse.status, count: invoicesData.data.length };
                
                // Test constantes
                const constantsResponse = await fetch(`${API_BASE}/api/invoices/constants`);
                const constantsData = await constantsResponse.json();
                results.constants = { status: constantsResponse.status, categories: Object.keys(constantsData.categories).length };
                
                displayResult('all-tests-result', { 
                    summary: "Tous les tests ont √©t√© ex√©cut√©s",
                    results: results 
                });
                
            } catch (error) {
                displayResult('all-tests-result', { error: error.message }, true);
            }
        }
    </script>
</body>
</html>
